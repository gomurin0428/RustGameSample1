# RealGeopolitics 改修ロードマップ

Eversim 社の *Geo-Political Simulator* 系列を意識し、本プロジェクトを段階的に拡張するための改修方針をまとめます。既存のリアルタイム予算配分モデルを核に、複合システムとゲーム体験を段階的に構築することを目的としています。

## 1. シミュレーション基盤の強化
- **時刻解像度とスケジューラ**: 現状 1h 相当 tick を柔軟化し、分・時間・日単位でイベント発火を制御するスケジューラを `GameState` に追加。国内・国際イベントをカテゴリごとにキュー管理。
- **国家データの階層化**: `CountryDefinition` を分離し、人口構成・地域ブロック・資源セクターなどを別構造体に分割。JSON 定義を階層化し、将来的な DLC 的拡張を想定。
- **収支モデル拡張**: 予算配分とは別に、税収・天然資源・債務のダイナミックモデルを導入。各国ごとに債務上限・利率・信用格付けを持たせ、財政破綻をゲーム要素化。

## 2. 内政システム
- **政策ツリー**: 予算配分に加え、長期政策（教育改革・保健医療・インフラ大型投資など）を選択式で実装。効果はグラデーションかつ遅延発生させ、政治的コストを伴う。
- **世論・世代別支持**: Approval を単一値から、都市部・地方・若年・高齢といったセグメント別支持率に分割。政策やイベントがセグメント単位で異なる影響を与えるよう調整。
- **ランダムイベントの体系化**: イベントテンプレートを作成し、トリガ条件・影響範囲・プレイヤーのレスポンス選択肢をデータドリブン化。イベント回答に応じた結果を複数分岐で実装。

## 3. 外交・軍事システム
- **多国間関係グラフ**: 現在の双方向数値を、同盟・通商協定・軍事協力などの状態付きグラフへ拡張。`Alliance`, `Treaty` 構造体を導入し、関係の種類ごとに維持コストや効果を持たせる。
- **危機シミュレーション**: 国境紛争や代理戦争イベントを導入。緊張値が閾値を超えると危機モードに入り、プレイヤーは仲裁・軍備増強・撤退などの即時対応が必要となる。
- **諜報・影響力**: スパイネットワークを抽象化し、他国の統計可視化・クーデター支援・サイバー攻撃などの covert オプションを実装。外交予算配分の消費先として活用。

## 4. 経済モデルと市場
- **セクター別 GDP**: GDP を一次産業・二次産業・サービスなどに分類し、政策やイベントがセクター別に作用。世界市場価格や資源需給も導入。
- **金融市場**: 為替・株式・国債利回りを簡略モデルで追加。市場ショックイベントと連動させ、財政・外交判断のフィードバックを実現。
- **貿易ネットワーク**: 二国間の輸出入を表現する `TradeRoute` を導入し、関税や制裁・FTA の効果を反映。外交／経済政策の影響を数値化。

## 5. UI/UX と可視化
- **ダッシュボード統合**: 主要メトリクスのグラフ化（折れ線・スタacked bar など）を Yew + ECharts/WebGL 等で実装。タイムライン再生やイベントログのフィルタリング機能を追加。
- **意思決定支援**: 政策選択時に予測効果ヒートマップや KPI 変化のプレビューを表示。内部的にはシミュレーションを短期回して結果を提示。
- **チュートリアル・アドバイザー**: AI アドバイザーキャラクタを設置し、推奨政策・警告・国家目標を提示。難易度設定で助言頻度を調整。

## 6. 技術スタックとアーキテクチャ
- **モジュール分割**: `core` をさらに `economy`, `diplomacy`, `domestic`, `events` などに分割し、依存関係を最小化。テストしやすい小モジュールへ整理。
- **データ駆動設計**: YAML/JSON/CSV を組み合わせ、イベント定義や政策ツリーを外部ファイルで管理。将来的なユーザーモッドにも備える。
- **セーブ/ロード対応**: WASM/CLI 共通で JSON シリアライズによるセーブ・ロード機構を実装。履歴やイベントスタックも保存対象に含める。

## 7. ロードマップ提案
1. **フェーズ1 (基盤強化)**: スケジューラ、財政モデル、イベントテンプレート、UI ダッシュボードの原型を実装。
2. **フェーズ2 (外交・軍事拡張)**: 同盟・条約・危機処理・諜報を実装し、外交 UI を拡張。
3. **フェーズ3 (経済・内政の深化)**: セクター別経済と世論セグメント、政策ツリー、金融市場を実装。
4. **フェーズ4 (UX とコンテンツ拡充)**: チュートリアル、アドバイザー、ストーリーキャンペーンやチャレンジシナリオを追加。

### フェーズ1 詳細設計

#### 1. タイムスケジューラ
- [x] **多層カレンダー**: ゲーム内時刻を `GameClock` (分精度) と `CalendarDate` (日/月/年) の二層で管理。`GameState` に `Scheduler` 構造体を追加し、`VecDeque<ScheduledTask>` でイベントを管理。
- [x] **タスク種別**: `EconomicTick`, `EventTrigger`, `PolicyResolution`, `DiplomaticPulse` を列挙体で定義し、`ScheduledTask::execute(&mut GameState, scale)` で処理を実装済み。
- [x] **優先度付き挿入**: 近い未来のタスクを `BinaryHeap` で優先度管理し、長期タスクは `VecDeque` に保持。メモリ節約のため、1年先以降のタスクは圧縮される実装を導入済み。
- [x] **繰り返しタスク**: `ScheduleSpec` により毎時/毎日/毎週などの再登録を実装済み。タスク実行後に自動的に次回スケジュールを登録。
- [x] **UI 連携**: `TimeStatus` でゲーム時間と次イベント予測を公開し、GUI は日付・残り時間・速度選択 (低速/標準/高速/超高速/カスタム) を常時表示。時間倍率は即時反映され、`tick_minutes` は倍率付きで進行。

#### 2. 拡張財政モデル
- [x] **収支勘定**: 各国に `FiscalAccount` を導入。`RevenueSource`/`ExpenseItem` で直近 tick の収支を追跡し、`credit_rating` に応じた利払いを自動計上。`cash_reserve` は CLI/GUI 両方で参照でき、UI には収入/支出カラムも追加済み。
- [x] **税制モジュール**: `TaxPolicy` で所得/法人/消費税率と控除を管理。GDP・雇用感応度を考慮した `collect` により即時 70%/遅延 30% の税収を算出し、繰越分は次 tick に自動加算。CLI/GUI で税制指標を可視化済み。
- [x] **資源・輸出入収益**: `CommodityMarket` を新設し、ランダムウォーク + ショックイベントで価格を更新。資源指数に応じた輸出収入を `RevenueKind::ResourceExport` へ計上し、CLI/GUI に単価を表示。
- [x] **歳出分類**: 配分カテゴリを `infra`/`military`/`welfare`/`diplomacy` に債務返済・行政維持・研究開発を追加した 7 区分へ再編。GDP 比率 (%) 指定の `BudgetAllocation` と `ensure_core_minimum` フラグを導入し、CLI の `set` (7 数値 + `core|nocore`) と Web NumericUpDown で同一仕様の割合入力が可能になった。
- [x] **債務 Dynamics**: `FiscalAccount` の `update_fiscal_cycle()` で利払い・償還・新規発行を処理。信用格付けに応じて利率変動し、一定閾値で債務危機イベントをトリガ。
- [x] **レポート API**: 国ごとの財政サマリ (`FiscalSnapshot`) を公開し、GUI から財政履歴を取得可能にした。Web UI では折れ線チャートで収入・支出・債務の推移を描画し、最新数値と現金残高を同時にハイライト表示する。

#### 3. イベントテンプレートと UI ダッシュボードへの連携 (抜粋)
- [x] **イベント定義**: `events/` ディレクトリに配置した YAML/JSON テンプレートをビルド時に読み込み、条件式 (例: `stability < 40 && debt_ratio > 90%`) を解析して該当国に `ScriptedEvent` タスクを登録。効果は財政・指標の加算/減算とレポートログ出力で表現できるようにした。
- [x] **ダッシュボード**: フロントエンドに GDP・バランスシート・債務比率・世論指数のカードを実装し、直近 12 tick の債務比率推移を SVG ラインチャートで可視化した。

### 一次〜三次産業・エネルギーセクター拡張計画

#### 仕様概要
- **産業カテゴリとセクター**
  - 一次産業: 穀物、野菜、鉱業、林業、漁業などを `PrimarySector` として管理し、各セクターは「生産量」「コスト」「市場価格感応度」を持つ。
  - 二次産業: 自動車、鉄鋼、化学、建設などの加工業を `SecondarySector` として定義。投入資源として一次産業の原材料とエネルギーを参照。
  - 三次産業: 金融、観光、物流、ICT などを `TertiarySector` としてモデル化し、GDP・雇用への貢献と消費者信頼指数をパラメータに含める。
  - エネルギー産業: 発電（火力・原子力・再エネ）、燃料採掘、送電を `EnergySector` として分割し、国家全体のエネルギーコストを決定。
- **セクター依存関係**
  - エネルギー価格が二次・三次産業の可変コストに乗算され、供給改善で生産単価が低下する。
  - 一次→二次→三次の縦方向サプライチェーンを浅い行列で表現し、原材料不足時には下流産業の稼働率にペナルティを適用。
  - 逆方向の需要（例: 建設セクターの資材需要が一次産業の収益に波及）も一段階まで反映する。
- **補助金・政策**
  - 政策 UI からセクター単位の補助金割合を設定し、短期的には生産コストを低減、長期的には設備投資ボーナスとして生産能力を漸増させる。
  - 補助金は財政支出として `ExpenseKind::IndustrySupport` を追加し、国債または税収を財源とする。
  - 支援には効率係数と減衰があり、過剰補助で限界効果が逓減するようクリップ。
- **市場メカニズム**
  - グローバル価格を `WorldMarket` に追加し、主要資源・燃料・製品の外生ショックをイベントテンプレートで定義。
  - 国内供給不足は輸入に置き換わり、貿易収支へ影響（フェーズ3の貿易拡張と接続）。
- **KPI 反映**
  - 産業別 GDP、雇用、輸出額を `IndustrySnapshot` として収集し、ダッシュボードの新タブで可視化。
  - エネルギーセクターの安定性が停電イベント確率、環境指標、世論へ連鎖するフックを用意。

#### 実装ステップ案
1. **データ構造定義**
   - `core::game::economy::industry` モジュールを新設し、`IndustryCategory`, `SectorId`, `SectorState`, `SectorDependency` を追加。
   - `config/industries/*.yaml` にカテゴリ・セクター・依存の初期値と市場パラメータを定義。
2. **シミュレーションループ拡張**
   - `GameState::tick_minutes` 内で産業更新フェーズを追加。エネルギーコスト→一次産業→二次→三次の順で生産量と収益を計算し、`FiscalAccount` と GDP へ反映。
   - 補助金やイベント効果を `SectorModifier` として取り込み、設備投資や効率ボーナスを時間経過で反映。
3. **依存関係と価格リンク**
   - `SectorDependencyGraph` を構築し、供給不足・過剰の閾値を評価。価格は需要供給ギャップに基づくシグモイド関数で更新。
   - エネルギーコスト指数をエネルギーセクターの総供給量で決定し、他セクターのコストに乗算。
4. **政策 UI と CLI 拡張**
   - CLI: `industry subsidize <sector> <percent>` コマンドを実装し、セクター補助金を即時適用できるようにした。
   - Web: ダッシュボードに「産業」タブを追加し、セクター別スライダーと KPI グラフ（棒／折れ線）で指標を可視化。
5. **イベント / バランス**
   - イベントテンプレートに「資源ブーム」「エネルギー危機」「物流停滞」など産業パラメータを操作する効果を追加。
   - チューニング用にシナリオデータを作成し、経済ショック後の回復挙動をテスト。
6. **テストと回帰**
   - 新規単体テスト: 依存関係が意図通り稼働率に影響すること、補助金で生産力が上がること、財政支出が増加することを検証。
   - バランステスト: 10 年相当の自動シミュレーションを走らせ、債務・GDP・価格指数が発散しないことを確認。

各フェーズ完了ごとに回帰テスト・バランス調整を行い、長期的にはデータドリブンな拡張性とモッドサポートを視野に入れた運用を行います。


# TODO

- [ ] 産業各セクターに潜在需要・供給能力・在庫などの指標を追加し、`SectorState` に保持できるよう拡張する。
- [ ] 需要・供給ギャップを評価する新しい依存関係ロジックを設計し、`compute_dependency_effects` を置き換える。
- [ ] 需要供給ギャップを入力にとる価格決定関数へ刷新し、供給不足時に価格が上がり過剰時に下がるよう調整する。
- [ ] 望ましい生産量を需要から導き出し、補助金や効率ボーナスが供給能力・調整率に反映される生産更新ループを実装する。
- [ ] 供給不足時の未充足需要や過剰供給時の在庫を扱う仕組みを導入し、次 tick の需要・価格へ連動させる。
- [ ] 上記変更をカバーするユニットテストと長期シミュレーションによる回帰テストを追加し、発散が起きないか検証する。
