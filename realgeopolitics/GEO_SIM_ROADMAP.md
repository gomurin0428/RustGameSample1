# RealGeopolitics 改修ロードマップ

Eversim 社の *Geo-Political Simulator* 系列を意識し、本プロジェクトを段階的に拡張するための改修方針をまとめます。既存のリアルタイム予算配分モデルを核に、複合システムとゲーム体験を段階的に構築することを目的としています。

## 1. シミュレーション基盤の強化
- **時刻解像度とスケジューラ**: 現状 1h 相当 tick を柔軟化し、分・時間・日単位でイベント発火を制御するスケジューラを `GameState` に追加。国内・国際イベントをカテゴリごとにキュー管理。
- **国家データの階層化**: `CountryDefinition` を分離し、人口構成・地域ブロック・資源セクターなどを別構造体に分割。JSON 定義を階層化し、将来的な DLC 的拡張を想定。
- **収支モデル拡張**: 予算配分とは別に、税収・天然資源・債務のダイナミックモデルを導入。各国ごとに債務上限・利率・信用格付けを持たせ、財政破綻をゲーム要素化。

## 2. 内政システム
- **政策ツリー**: 予算配分に加え、長期政策（教育改革・保健医療・インフラ大型投資など）を選択式で実装。効果はグラデーションかつ遅延発生させ、政治的コストを伴う。
- **世論・世代別支持**: Approval を単一値から、都市部・地方・若年・高齢といったセグメント別支持率に分割。政策やイベントがセグメント単位で異なる影響を与えるよう調整。
- **ランダムイベントの体系化**: イベントテンプレートを作成し、トリガ条件・影響範囲・プレイヤーのレスポンス選択肢をデータドリブン化。イベント回答に応じた結果を複数分岐で実装。

## 3. 外交・軍事システム
- **多国間関係グラフ**: 現在の双方向数値を、同盟・通商協定・軍事協力などの状態付きグラフへ拡張。`Alliance`, `Treaty` 構造体を導入し、関係の種類ごとに維持コストや効果を持たせる。
- **危機シミュレーション**: 国境紛争や代理戦争イベントを導入。緊張値が閾値を超えると危機モードに入り、プレイヤーは仲裁・軍備増強・撤退などの即時対応が必要となる。
- **諜報・影響力**: スパイネットワークを抽象化し、他国の統計可視化・クーデター支援・サイバー攻撃などの covert オプションを実装。外交予算配分の消費先として活用。

## 4. 経済モデルと市場
- **セクター別 GDP**: GDP を一次産業・二次産業・サービスなどに分類し、政策やイベントがセクター別に作用。世界市場価格や資源需給も導入。
- **金融市場**: 為替・株式・国債利回りを簡略モデルで追加。市場ショックイベントと連動させ、財政・外交判断のフィードバックを実現。
- **貿易ネットワーク**: 二国間の輸出入を表現する `TradeRoute` を導入し、関税や制裁・FTA の効果を反映。外交／経済政策の影響を数値化。

## 5. UI/UX と可視化
- **ダッシュボード統合**: 主要メトリクスのグラフ化（折れ線・スタacked bar など）を Yew + ECharts/WebGL 等で実装。タイムライン再生やイベントログのフィルタリング機能を追加。
- **意思決定支援**: 政策選択時に予測効果ヒートマップや KPI 変化のプレビューを表示。内部的にはシミュレーションを短期回して結果を提示。
- **チュートリアル・アドバイザー**: AI アドバイザーキャラクタを設置し、推奨政策・警告・国家目標を提示。難易度設定で助言頻度を調整。

## 6. 技術スタックとアーキテクチャ
- **モジュール分割**: `core` をさらに `economy`, `diplomacy`, `domestic`, `events` などに分割し、依存関係を最小化。テストしやすい小モジュールへ整理。
- **データ駆動設計**: YAML/JSON/CSV を組み合わせ、イベント定義や政策ツリーを外部ファイルで管理。将来的なユーザーモッドにも備える。
- **セーブ/ロード対応**: WASM/CLI 共通で JSON シリアライズによるセーブ・ロード機構を実装。履歴やイベントスタックも保存対象に含める。

## 7. ロードマップ提案
1. **フェーズ1 (基盤強化)**: スケジューラ、財政モデル、イベントテンプレート、UI ダッシュボードの原型を実装。
2. **フェーズ2 (外交・軍事拡張)**: 同盟・条約・危機処理・諜報を実装し、外交 UI を拡張。
3. **フェーズ3 (経済・内政の深化)**: セクター別経済と世論セグメント、政策ツリー、金融市場を実装。
4. **フェーズ4 (UX とコンテンツ拡充)**: チュートリアル、アドバイザー、ストーリーキャンペーンやチャレンジシナリオを追加。

### フェーズ1 詳細設計

#### 1. タイムスケジューラ
- [x] **多層カレンダー**: ゲーム内時刻を `GameClock` (分精度) と `CalendarDate` (日/月/年) の二層で管理。`GameState` に `Scheduler` 構造体を追加し、`VecDeque<ScheduledTask>` でイベントを管理。
- [x] **タスク種別**: `EconomicTick`, `EventTrigger`, `PolicyResolution`, `DiplomaticPulse` を列挙体で定義し、`ScheduledTask::execute(&mut GameState, scale)` で処理を実装済み。
- [x] **優先度付き挿入**: 近い未来のタスクを `BinaryHeap` で優先度管理し、長期タスクは `VecDeque` に保持。メモリ節約のため、1年先以降のタスクは圧縮される実装を導入済み。
- [x] **繰り返しタスク**: `ScheduleSpec` により毎時/毎日/毎週などの再登録を実装済み。タスク実行後に自動的に次回スケジュールを登録。
- [x] **UI 連携**: `TimeStatus` でゲーム時間と次イベント予測を公開し、GUI は日付・残り時間・速度選択 (低速/標準/高速/超高速/カスタム) を常時表示。時間倍率は即時反映され、`tick_minutes` は倍率付きで進行。

#### 2. 拡張財政モデル
- [x] **収支勘定**: 各国に `FiscalAccount` を導入。`RevenueSource`/`ExpenseItem` で直近 tick の収支を追跡し、`credit_rating` に応じた利払いを自動計上。`cash_reserve` は CLI/GUI 両方で参照でき、UI には収入/支出カラムも追加済み。
- [x] **税制モジュール**: `TaxPolicy` で所得/法人/消費税率と控除を管理。GDP・雇用感応度を考慮した `collect` により即時 70%/遅延 30% の税収を算出し、繰越分は次 tick に自動加算。CLI/GUI で税制指標を可視化済み。
- [x] **資源・輸出入収益**: `CommodityMarket` を新設し、ランダムウォーク + ショックイベントで価格を更新。資源指数に応じた輸出収入を `RevenueKind::ResourceExport` へ計上し、CLI/GUI に単価を表示。
- [x] **歳出分類**: 配分カテゴリを `infra`/`military`/`welfare`/`diplomacy` に債務返済・行政維持・研究開発を追加した 7 区分へ再編。GDP 比率 (%) 指定の `BudgetAllocation` と `ensure_core_minimum` フラグを導入し、CLI の `set` (7 数値 + `core|nocore`) と Web NumericUpDown で同一仕様の割合入力が可能になった。
- [x] **債務 Dynamics**: `FiscalAccount` の `update_fiscal_cycle()` で利払い・償還・新規発行を処理。信用格付けに応じて利率変動し、一定閾値で債務危機イベントをトリガ。
- [x] **レポート API**: 国ごとの財政サマリ (`FiscalSnapshot`) を公開し、GUI から財政履歴を取得可能にした。Web UI では折れ線チャートで収入・支出・債務の推移を描画し、最新数値と現金残高を同時にハイライト表示する。

#### 3. イベントテンプレートと UI ダッシュボードへの連携 (抜粋)
- **イベント定義**: `events/` ディレクトリに YAML/JSON のテンプレートを配置し、スケジューラが読み込み。条件式 (例: `stability < 40 && debt_ratio > 90%`) を評価し、該当時にタスクを登録。
- **ダッシュボード**: フロントエンドでメトリクスカード (GDP, バランスシート, 債務比率, 世論指数) を表示。トレンドグラフは直近 12 tick を描画。

各フェーズ完了ごとに回帰テスト・バランス調整を行い、長期的にはデータドリブンな拡張性とモッドサポートを視野に入れた運用を行います。
